---
title: "GNG_TUS_Study_1_320trials_ANALYSIS"
author: "nomi"
date: "2023-10-31"
output: html_document
---

#READ FILE
```{r setup, include=FALSE}
library(readr)
tus <- read_csv("GNG_TUS_S1.csv")
View(tus)
```

#Load libraries
```{r}
library(lmerTest)
library(lMest)
library(dplyr)
library(BayesFactor)
library(tidyverse)
library(BANOVA)
library (rstan)
library(afex)
library(rstanarm)
library(stringr)
library(report)
library(jtools) #for explanation of lmer
library(emmeans)#2 prefictor, one should be continuous (the "var")
library(effects)
library(lme4)
library(bbmle)
```

#Analysis

  ##Accuracy

    ##NB RUN A BASIC ANOVA !!!!!!!!!!!
```{r}
oneway.test(correct ~ condition,
  data = tus,
  var.equal = TRUE) # assuming equal variances

model <- aov(correct ~ condition * req_action * OutValence, data=tus)
summary(model)

summary(aov(correct ~ condition * req_action * OutValence + Error(ID/(condition * req_action * OutValence)), data=tus))
summary(aov(correct ~ condition * req_action *  OutValence + Error(ID), data=tus)) # separately testing effect of IVs but their interaction too- not sure if correct??????
```


 ##logistic regression
      ####???Should check for multicollinearity by calculating a Variance Inflation Factor (VIF) for each independent variable maybe?
```{r}

#1. all main effects are significant 
model_acc <- glmer(correct ~ OutValence + req_action + condition +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
summary (model_acc) 

#2. all main effects are significant
model_acc <- glmer(correct ~ OutValence + req_action + condition + trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
summary (model_acc) 

#3. all main effects and interaction is significant. val*req_action = Cue
model_acc <- glmer(correct ~ OutValence * req_action + condition + trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
summary (model_acc) 

#4 val*req_action = Cue
model_acc <- glmer(correct ~ OutValence * req_action * condition + trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
summary (model_acc) 

#what elsa also proposed, but I do not think it counts for the main effects, changes the B level.
       #model_acc <- glmer(correct ~ OutValence + req_action + condition + trial_number + (OutValence * req_action * condition * trial_number) + (1|ID) ,        #data  = tus, family="binomial", 
       #glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
      #summary (model_acc) 


#Not sure how to interpret this or how to plot:
acc <- allEffects(model_acc, xlevels=list(req_action=seq(0, 24, 6)),
                   fixed.predictors=list(given.values=c(OutValenceWin =0.5)));eff.cowles

as.data.frame(acc[[2]])

# the following are equivalent:
eff.ne <- effect("OutValence*req_action", model_acc)
Eff.ne <- Effect(c("OutValence", "req_action"), model_acc)
all.equal(eff.ne$fit, Eff.ne$fit)

# Assuming you have extracted the estimated effects into a data frame
# For example, using as.data.frame(eff.cowles[[2]])-->
# Create a ggplot object - not working yet
acc<-as.data.frame(acc)
ggplot(data =acc, aes(x = req_action, y = fit)) +
  geom_point() +  # Add points to the plot
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +  # Add error bars
  labs(x = "req_action", y = "Effect") +  # Label the axes
  ggtitle("Estimated Effects of req_action")  # Add a title

#or  #not working either - i do not know
plot(acc, 'OutValence', axes=list(grid=TRUE,
y=list(lab="condition"),
x=list(rotate=90)),
lines=list(lty=0))
```

#testing models with and with no effects or interactions
```{r}
# Full model with the interaction term
full_model <- glmer(correct ~ OutValence * req_action * condition +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
# Reduced model without the interaction term
reduced_model <- glmer(correct ~ OutValence + req_action + condition +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE

# Perform likelihood ratio test
lr_test <- anova(full_model, reduced_model)

# Access the p-value for the interaction term
p_value_interaction <- lr_test$`Pr(>Chisq)`["full_model: correct ~ OutValence * req_action * condition + (1 | ID)"]

# Display the p-value
p_value_interaction
```

#comparing more models
```{r}
# Step 1: Fit a series of GLM models
model1 <- glmer(correct ~ OutValence + req_action + condition +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
model2 <- glmer(correct ~ OutValence + req_action + condition + trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
model3 <- glmer(correct ~ OutValence * req_action + condition + trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
model4 <- glmer(correct ~ OutValence * req_action * condition +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
model5 <- glmer(correct ~ OutValence * req_action * condition * trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
model6 <- glmer(correct ~ Cue + condition + trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
model7 <- glmer(correct ~ Cue + condition + OutValence + trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
model8 <- glmer(correct ~ Cue * condition + trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
model9 <- glmer(correct ~ Cue * condition * trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
model10 <- glmer(correct ~ Cue * condition * OutValence* req_action* trial_number +(1|ID) , 
                 data  = tus, family="binomial", glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE


# Step 2: Calculate model fit statistics
model1_aic <- AIC(model1)
model2_aic <- AIC(model2)
model3_aic <- AIC(model3)
model4_aic <- AIC(model4)
model5_aic <- AIC(model5)
model6_aic <- AIC(model6)
model7_aic <- AIC(model7)
model8_aic <- AIC(model8)
model9_aic <- AIC(model9)
model10_aic <- AIC(model10)


# Step 3: Compare models using AIC
aic_values <- c(model1_aic, model2_aic, model3_aic,model4_aic, model5_aic, model6_aic, model7_aic, model8_aic, model9_aic, model10_aic)
cat("BIC comparison:\n")
cat("Model", best_model_bic$model, "has the lowest BIC:", best_model_bic$BIC, "\n")

```


#Reporting

```{r}
summ(model_acc, exp = T)# set "exp = T" to show esponentiated estimates; if you need standardised estimaets, set "scale = T"
summ(model_acc, scale = T)
report(model_acc)
report(model_acc) %>% summary()
report_table(model_acc)
report_performance(model_acc)
report_parameters(model_acc)
```


```{r}
 #5 Cue impact - CUE as IV 
   # is significant, but not the dACC:NGL. I am not sure why, because in the plot the AI is closer to Sham than the dACC!!!!!!!!!!!!!!!!!!
model_acc_cue <- glmer(correct ~ Cue * condition*trial_number + (1 +Cue + condition +trial_number|ID) ,
                 data  = tus, family="binomial", 
                 glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
summary (model_acc_cue) 
summ(model_acc_cue, exp = T)# set "exp = T" to show esponentiated estimates; if you need standardised estimaets, set "scale = T"
summ(model_acc_cue, scale = T)

#visualize how spread accuracy is - higher variability for the STIMs
tus_correct_sub <- na.omit(tus_correct_sub)#omit NAs

ggplot(tus_correct_sub, aes(x = correct , y = req_action, color=req_action))+
               geom_jitter(stat = "identity")+
    facet_grid(~condition)
geom_smooth(method= "lm", se = TRUE)


#run anovaBF (not the correct analysis as the DV is categorical - just trying)
#BF
tus$ID <- as.factor(tus$ID)
tus$req_action <- as.factor(tus$req_action)
tus$condition <- as.factor(tus$condition)
tus$trial_number <- as.factor(tus$trial_number)
tus$OutValence <- as.factor(tus$OutValence)
tus$Cue <- as.factor(tus$Cue)


#drop NAs
df <- na.omit(tus)
df$ID <- as.factor(df$ID)
df$correct <- as.integer(df$correct)
df$req_action <- as.factor(df$req_action)
df$condition <- as.factor(df$condition)
df$trial_number <- as.factor(df$trial_number)
df$OutValence <- as.factor(df$OutValence)
df$Cue <- as.factor(df$Cue)

#anovaBF IV = req_action
 accu <-anovaBF(correct ~ req_action*condition  + ID, data = df, whichRandom = "ID",
   progress=FALSE)
accu[4]/accu[3]

#anovaBF IV = Cue - interaction between the Cue and the condition
accu_cue <-anovaBF(correct ~ Cue*condition  + ID, data = df, whichRandom = "ID",
   progress=FALSE)
accu_cue[4]/accu_cue[3]
lm(RT ~ condition +req_action +OutValence, data=tus)


#banova!!!!!!!! - not working atm
# Making sure JAGS is installed
# It can be downloaded here http://mcmc-jags.sourceforge.net (the size is only 2.3 MB)

BANOVA::BANOVA.run (correct ~ req_action, ~condition*req_action, data=df, model_name = 'Binomial', id = 'ID',
                        as.integer(16), num_trials = as.integer(20), iter = 100, thin = 5, chains = 2)
```

#RTs

```{r}
model_rt <- lmer(RT ~ req_action  + OutValence +session+ req_action*condition*trial_number +(1|ID), # + trial_number (excluded cause it gives me the outcome of all trials, it does not group them)
                 data  = tus, REML = FALSE) #REML = FALSE
summary (model_rt) 
    #print(model_rt, correlation=FALSE)
report_table(model_rt)



#run anovaBF IV = req_action and condition
 rt <-anovaBF(RT ~ req_action*condition  + ID, data = df, whichRandom = "ID",
   progress=FALSE)
accu[4]/accu[3]
summary(rt)

 


#Cue impact
model_rt_cue <- lmer(RT ~ Cue*condition +(1|ID) , 
                 data  = tus,REML = FALSE) #REML = FALSE
summary (model_rt_cue) 

#simple anova
anova(model_rt)

#anovaBF IV = Cue - interaction between the Cue and the condition
rt_cue <-anovaBF(RT ~ Cue*condition  + ID, data = df, whichRandom = "ID",
   progress=FALSE)
rt_cue[4]/rt_cue[3]
summary(rt_cue)
```


          
          
  # ANALYSIS FOR SALIENT ONLY (EXCLUDE NEUTRAL OUTCOME)
  
```{r}
#select salient only (win, lose) and keep variables ID through block and all columns between them
tus_salient <- subset(tus, salient=!"neutral",
select=ID:salient);  

salient_df <-tus_salient %>% drop_na();  View(salient_df) # WRONG IT DRPOPS ACC AS WELL

```  

        
## Accuracy
```{r}
model_acc_sal <- glmer(correct ~ condition + req_action + trial_number + OutValence*condition + req_action*condition +(1|ID) , 
                 data  = salient_df, family="binomial", 
                 glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALS
summary(model_acc_sal)

#Cue impact
sal_cue_accu <- glmer(correct ~ Cue*condition*trial_number +(1|ID) , 
                 data  = salient_df, family="binomial", 
                 glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) #REML = FALSE
summary (sal_cue_accu) 
```

## RTs
```{r}
model_rt_sal <- lmer(RT ~ req_action  + trial_number + OutValence*condition + req_action*condition+(1|ID), 
                 data  = salient_df, REML = FALSE) #REML = FALSE
summary (model_rt_sal) 
report_table(model_rt_sal)
#Cue impact
sal_cue_rt <- lmer(RT ~ Cue*condition +(1|ID), 
                 data  = salient_df, REML = FALSE) #REML = FALSE
summary (sal_cue_rt) 
```


 ##Analysis with Bayesian binomial/logistic anova for the categorical DV - "correct"
      # with rstarm + bridging

```{r}

library(htmltools)
options(mc.cores = 4)


cor.m1.stan <- rstanarm::stan_glmer(correct ~ condition * OutValence * req_action * Cue + (1|ID),  weights=trial_number,
                 data  = tus, family="binomial", chains=4, iter=2e4, 
                diagnostic_file = "__df1.csv") #deleted the "weights = ..."

cor.m1.0.stan <- rstanarm::stan_glmer(correct ~ (condition + OutValence + req_action) * Cue + (1|ID), weights=trial_number,
               data  = tus, family="binomial", chains=4, iter=2e4, 
                diagnostic_file = "__df0.csv") #notsure if this the base model. #deleted the "weights = ..."

bridge_1 <-bridgesampling::bridge_sampler(cor.m1.stan)
bridge_0 <- bridgesampling::bridge_sampler(cor.m1.0.stan)
# BW: this gives evidence (or not) for the interaction
bayes_factor(bridge_1, bridge_0, log = FALSE)



##model with no interaction 
acc.m2.stan <- rstanarm::stan_glmer(is_slip ~ condition * Cue + (1|ID), 
               data  = elm_test.byblock, family="binomial", chains=4, iter=2e4, 
                diagnostic_file = "__df2.csv")

acc.m3.0.stan <- rstanarm::stan_glmer(is_slip ~ condition + Cue + (1|ID), 
                weights=exposure, data  = elm_test.byblock, family="binomial", chains=4, iter=2e4, 
                diagnostic_file = "__df2.0.csv")

bridge_3 <-bridgesampling::bridge_sampler(acc.m2.stan)
bridge_3.0 <- bridgesampling::bridge_sampler(acc.m3.0.stan)


# evidence
bayes_factor(bridge_3, bridge_3.0, log = FALSE)

```

